{% extends "base.html" %}

{% block title %}Analysis Results - Building Defect Detector{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-clipboard-check"></i> Analysis Results</h2>
            <a href="{{ url_for('upload_file') }}" class="btn btn-outline-primary">
                <i class="fas fa-upload"></i> Analyze Another Report
            </a>
        </div>

        <!-- Summary Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-file-alt"></i> Report Summary</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>File:</strong> {{ filename }}</p>
                        <p><strong>Total Defects Found:</strong> 
                            <span class="badge bg-{% if total_defects > 5 %}danger{% elif total_defects > 2 %}warning{% else %}success{% endif %} fs-6">
                                {{ total_defects }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Analysis Date:</strong> {{ analysis_time }}</p>
                        <p><strong>Status:</strong> 
                            <span class="badge bg-success">Complete</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Summary Stats -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Defects by Category</h5>
                    </div>
                    <div class="card-body">
                        {% if summary %}
                            {% for defect_type, count in summary.items() %}
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span><strong>{{ defect_type }}</strong></span>
                                <span class="badge bg-{% if count > 3 %}danger{% elif count > 1 %}warning{% else %}info{% endif %} fs-6">{{ count }}</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted">
                                <i class="fas fa-check-circle fa-3x mb-3"></i>
                                <p>No defects detected!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5><i class="fas fa-tools"></i> Actions</h5>
                    </div>
                    <div class="card-body text-center">
                        <button class="btn btn-success mb-2" onclick="exportToCSV()">
                            <i class="fas fa-file-csv"></i> Export CSV
                        </button>
                        <br>
                        <button class="btn btn-info mb-2" onclick="window.print()">
                            <i class="fas fa-print"></i> Print Report
                        </button>
                        <br>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
                            <i class="fas fa-chart-line"></i> View Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Defect List -->
        {% if defects %}
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-exclamation-triangle"></i> Detailed Findings ({{ defects|length }} total)</h5>
            </div>
            <div class="card-body">
                {% for defect in defects %}
                <div class="card mb-3 border-left-{{ 'danger' if defect.severity == 'High' else 'warning' if defect.severity == 'Medium' else 'success' }}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <span class="badge bg-{% if defect.severity == 'High' %}danger{% elif defect.severity == 'Medium' %}warning{% else %}success{% endif %}">
                                    {{ defect.severity }}
                                </span>
                            </div>
                            <div class="col-md-3">
                                <strong>{{ defect.type }}</strong>
                            </div>
                            <div class="col-md-2">
                                <code>{{ defect.keyword }}</code>
                            </div>
                            <div class="col-md-5">
                                <small class="text-muted">{{ defect.sentence[:120] }}{% if defect.sentence|length > 120 %}...{% endif %}</small>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- No Defects Message -->
        {% if not defects %}
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h4>Great News!</h4>
                <p class="text-muted">No significant defects were detected in this building survey report.</p>
                <a href="{{ url_for('upload_file') }}" class="btn btn-primary">
                    <i class="fas fa-upload"></i> Analyze Another Report
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- CSV Export Data (Hidden) -->
<div id="csvData" style="display: none;">
{{ defects | tojson }}
</div>

<script>
function exportToCSV() {
    try {
        const defectsData = JSON.parse(document.getElementById('csvData').textContent);
        
        const csvRows = [
            ['Type', 'Keyword', 'Severity', 'Context']
        ];
        
        defectsData.forEach(defect => {
            csvRows.push([
                defect.type,
                defect.keyword,
                defect.severity,
                defect.sentence.substring(0, 200)
            ]);
        });
        
        const csvContent = csvRows.map(row => 
            row.map(field => '"' + String(field).replace(/"/g, '""') + '"').join(',')
        ).join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'defect_analysis_{{ filename }}.csv';
        a.click();
        window.URL.revokeObjectURL(url);
    } catch (error) {
        alert('Export failed: ' + error.message);
    }
}
</script>
{% endblock %}
